<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squad Bot</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0b0f;
            --bg-surface: #12131a;
            --bg-elevated: #1a1b25;
            --bg-hover: #222330;
            --border: #2a2b3a;
            --border-active: #4a4b6a;
            --text-primary: #e8e9f0;
            --text-secondary: #8b8ca0;
            --text-muted: #5a5b70;
            --accent-blue: #5b8af5;
            --accent-green: #4ade80;
            --accent-amber: #fbbf24;
            --accent-red: #f87171;
            --accent-purple: #a78bfa;
            --accent-cyan: #22d3ee;
            --model-claude: #d4a574;
            --model-chatgpt: #74d4a5;
            --model-gemini: #74a5d4;
            --model-web: #d474a5;
            --glow-blue: rgba(91, 138, 245, 0.15);
            --glow-green: rgba(74, 222, 128, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
        }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 16px;
        }

        .header-logo {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
        }

        .header-status {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .context-version {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        /* â”€â”€ Members Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .members-panel {
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            padding: 20px 16px;
            overflow-y: auto;
        }

        .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .member-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            transition: background 0.15s;
        }

        .member-card:hover { background: var(--bg-hover); }

        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .member-info { flex: 1; min-width: 0; }

        .member-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-model {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
        }

        .model-claude .member-avatar { background: rgba(212, 165, 116, 0.15); color: var(--model-claude); }
        .model-chatgpt .member-avatar { background: rgba(116, 212, 165, 0.15); color: var(--model-chatgpt); }
        .model-gemini .member-avatar { background: rgba(116, 165, 212, 0.15); color: var(--model-gemini); }
        .model-web .member-avatar { background: rgba(212, 116, 165, 0.15); color: var(--model-web); }
        .model-unknown .member-avatar { background: rgba(139, 140, 160, 0.15); color: var(--text-secondary); }

        /* â”€â”€ Join Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .join-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .join-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            outline: none;
            margin-bottom: 8px;
            transition: border-color 0.15s;
        }

        .join-input:focus { border-color: var(--accent-blue); }

        .join-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .join-btn:hover { opacity: 0.9; }
        .join-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* â”€â”€ Chat Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: var(--bg-deep);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .msg-body { flex: 1; min-width: 0; }

        .msg-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
        }

        .msg-sender {
            font-weight: 600;
            font-size: 14px;
        }

        .msg-type-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .badge-human { background: rgba(91, 138, 245, 0.15); color: var(--accent-blue); }
        .badge-agent { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
        .badge-orchestrator { background: rgba(74, 222, 128, 0.15); color: var(--accent-green); }
        .badge-system { background: rgba(139, 140, 160, 0.1); color: var(--text-muted); }

        .msg-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
        }

        .msg-content {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            word-wrap: break-word;
        }

        .msg-content strong { font-weight: 600; }

        /* System messages */
        .message.system-message {
            justify-content: center;
            gap: 0;
        }

        .message.system-message .msg-content {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            font-style: italic;
        }

        /* Orchestrator messages */
        .message.orchestrator-message .msg-content {
            background: var(--bg-elevated);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid var(--accent-green);
        }

        /* â”€â”€ Chat Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-input-area {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-surface);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            outline: none;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: border-color 0.15s;
        }

        .chat-input:focus { border-color: var(--accent-blue); }
        .chat-input::placeholder { color: var(--text-muted); }
        .chat-input:disabled { opacity: 0.5; }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: var(--accent-blue);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: opacity 0.15s;
        }

        .send-btn:hover { opacity: 0.9; }
        .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* â”€â”€ Context Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .context-panel {
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .context-section {
            padding: 20px 16px;
            overflow-y: auto;
            flex: 1;
        }

        .context-entry {
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent-green);
        }

        .context-entry-version {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--accent-green);
            margin-bottom: 4px;
        }

        .context-entry-content {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .context-entry-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* â”€â”€ Pending Commits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .commits-section {
            padding: 16px;
            border-top: 1px solid var(--border);
            max-height: 300px;
            overflow-y: auto;
        }

        .commit-card {
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent-amber);
        }

        .commit-content {
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .commit-proposer {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .commit-votes {
            display: flex;
            gap: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .vote-count { color: var(--text-secondary); }
        .vote-count.approve { color: var(--accent-green); }
        .vote-count.reject { color: var(--accent-red); }

        .vote-actions {
            display: flex;
            gap: 6px;
        }

        .vote-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-surface);
            color: var(--text-secondary);
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .vote-btn.approve:hover { border-color: var(--accent-green); color: var(--accent-green); background: var(--glow-green); }
        .vote-btn.reject:hover { border-color: var(--accent-red); color: var(--accent-red); }

        /* â”€â”€ Connection status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .connection-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 6px;
        }

        .connected { color: var(--accent-green); background: rgba(74, 222, 128, 0.1); }
        .disconnected { color: var(--accent-red); background: rgba(248, 113, 113, 0.1); }

        /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-active); }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 1024px) {
            .app { grid-template-columns: 1fr; }
            .members-panel, .context-panel { display: none; }
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- Header -->
        <header class="header">
            <div class="header-logo">âš¡ SQUAD BOT</div>
            <div class="header-divider"></div>
            <div class="header-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">connecting...</span>
            </div>
            <div class="header-right">
                <span class="context-version" id="contextVersion">ctx v0</span>
                <span class="connection-status disconnected" id="connStatus">disconnected</span>
            </div>
        </header>

        <!-- Members Panel -->
        <aside class="members-panel">
            <div class="panel-title">Squad Members</div>
            <div id="membersList"></div>

            <div class="join-section">
                <div class="panel-title">Join Squad</div>
                <input class="join-input" id="joinName" placeholder="Your name" />
                <button class="join-btn" id="joinBtn" onclick="joinSquad()">Join as Human</button>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area">
            <div class="messages-container" id="messagesContainer"></div>
            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="chatInput"
                        placeholder="Type a message... (join the squad first)"
                        disabled
                        onkeydown="handleKeyDown(event)"
                        rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" disabled onclick="sendMessage()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </div>
        </main>

        <!-- Context Panel -->
        <aside class="context-panel">
            <div class="context-section">
                <div class="panel-title">Canonical Context</div>
                <div id="contextEntries">
                    <div class="empty-state">No context committed yet.<br>Propose commits as the squad reaches decisions.</div>
                </div>
            </div>
            <div class="commits-section">
                <div class="panel-title">Pending Commits</div>
                <div id="pendingCommits">
                    <div class="empty-state">No pending proposals.</div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Squad Bot Client
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const state = {
            ws: null,
            myName: null,
            members: [],
            messages: [],
            context: { version: 0, entries: [] },
            pendingCommits: [],
            connected: false,
        };

        // â”€â”€ WebSocket Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}/ws`;

            state.ws = new WebSocket(wsUrl);

            state.ws.onopen = () => {
                state.connected = true;
                updateConnectionStatus(true);
            };

            state.ws.onclose = () => {
                state.connected = false;
                updateConnectionStatus(false);
                // Reconnect after 3s
                setTimeout(connect, 3000);
            };

            state.ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleEvent(msg);
            };
        }

        function handleEvent(event) {
            switch (event.type) {
                case 'initial_state':
                    state.members = event.data.status.members || [];
                    state.messages = event.data.messages || [];
                    state.context = event.data.context || { version: 0, entries: [] };
                    state.pendingCommits = event.data.pending_commits || [];
                    renderAll();
                    break;

                case 'new_message':
                    state.messages.push(event.data);
                    renderMessages();
                    scrollToBottom();
                    break;

                case 'member_joined':
                    if (!state.members.find(m => m.id === event.data.id)) {
                        state.members.push(event.data);
                    }
                    renderMembers();
                    break;

                case 'member_left':
                    state.members = state.members.filter(m => m.id !== event.data.id);
                    renderMembers();
                    break;

                case 'context_updated':
                    state.context.entries.push(event.data);
                    state.context.version = event.data.version;
                    renderContext();
                    break;

                case 'commit_proposed':
                    state.pendingCommits.push({...event.data, votes: [], vote_summary: {approvals: 0, rejections: 0, abstentions: 0, total: 0}});
                    renderPendingCommits();
                    break;

                case 'commit_resolved':
                    state.pendingCommits = state.pendingCommits.filter(c => c.id !== event.data.commit_id);
                    renderPendingCommits();
                    break;

                case 'vote_cast':
                    const commit = state.pendingCommits.find(c => c.id === event.data.commit_id);
                    if (commit) {
                        commit.votes = commit.votes || [];
                        commit.votes.push(event.data);
                        const s = commit.vote_summary || {};
                        if (event.data.choice === 'approve') s.approvals = (s.approvals||0) + 1;
                        else if (event.data.choice === 'reject') s.rejections = (s.rejections||0) + 1;
                        else s.abstentions = (s.abstentions||0) + 1;
                        s.total = (s.total||0) + 1;
                    }
                    renderPendingCommits();
                    break;
            }
        }

        // â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function joinSquad() {
            const name = document.getElementById('joinName').value.trim();
            if (!name) return;

            state.myName = name;
            state.ws.send(JSON.stringify({
                action: 'send_message',
                sender_name: name,
                content: `${name} is here! (joined via web UI)`,
                sender_type: 'human'
            }));

            // Also join via REST
            fetch('/api/join', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, model: 'web' })
            });

            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('chatInput').placeholder = `Message as ${name}...`;
            document.getElementById('chatInput').focus();
            document.getElementById('joinBtn').disabled = true;
            document.getElementById('joinName').disabled = true;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content || !state.myName) return;

            state.ws.send(JSON.stringify({
                action: 'send_message',
                sender_name: state.myName,
                content: content,
                sender_type: 'human'
            }));

            input.value = '';
            input.style.height = '44px';
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function voteOnCommit(commitId, choice) {
            if (!state.myName) return;
            state.ws.send(JSON.stringify({
                action: 'vote',
                voter_name: state.myName,
                commit_id: commitId,
                choice: choice,
                is_human_override: true
            }));
        }

        // â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function renderAll() {
            renderMembers();
            renderMessages();
            renderContext();
            renderPendingCommits();
            scrollToBottom();
        }

        function getModelClass(model) {
            const m = (model || '').toLowerCase();
            if (m.includes('claude')) return 'model-claude';
            if (m.includes('gpt') || m.includes('chatgpt') || m.includes('openai')) return 'model-chatgpt';
            if (m.includes('gemini') || m.includes('google')) return 'model-gemini';
            if (m.includes('web')) return 'model-web';
            return 'model-unknown';
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function renderMembers() {
            const el = document.getElementById('membersList');
            if (!state.members.length) {
                el.innerHTML = '<div class="empty-state">No one here yet.</div>';
                return;
            }
            el.innerHTML = state.members.map(m => `
                <div class="member-card ${getModelClass(m.model)}">
                    <div class="member-avatar">${getInitials(m.name)}</div>
                    <div class="member-info">
                        <div class="member-name">${esc(m.name)}</div>
                        <div class="member-model">${esc(m.model)}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('statusText').textContent =
                `${state.members.length} member${state.members.length !== 1 ? 's' : ''} in squad`;
        }

        function renderMessages() {
            const el = document.getElementById('messagesContainer');
            el.innerHTML = state.messages.map(m => {
                const isSystem = m.sender_type === 'system';
                const isOrch = m.sender_type === 'orchestrator';
                const extraClass = isSystem ? 'system-message' : (isOrch ? 'orchestrator-message' : '');
                const time = new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

                if (isSystem) {
                    return `<div class="message system-message">
                        <div class="msg-body"><div class="msg-content">${formatContent(m.content)}</div></div>
                    </div>`;
                }

                const badgeClass = `badge-${m.sender_type}`;
                const avatarStyle = isOrch
                    ? 'background: rgba(74, 222, 128, 0.15); color: var(--accent-green);'
                    : m.sender_type === 'human'
                        ? 'background: rgba(91, 138, 245, 0.15); color: var(--accent-blue);'
                        : 'background: rgba(167, 139, 250, 0.15); color: var(--accent-purple);';

                return `<div class="message ${extraClass}">
                    <div class="msg-avatar" style="${avatarStyle}">
                        ${isOrch ? 'âš¡' : getInitials(m.sender_name)}
                    </div>
                    <div class="msg-body">
                        <div class="msg-header">
                            <span class="msg-sender">${esc(m.sender_name)}</span>
                            <span class="msg-type-badge ${badgeClass}">${m.sender_type}</span>
                            <span class="msg-time">${time}</span>
                        </div>
                        <div class="msg-content">${formatContent(m.content)}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderContext() {
            const el = document.getElementById('contextEntries');
            document.getElementById('contextVersion').textContent = `ctx v${state.context.version}`;

            if (!state.context.entries.length) {
                el.innerHTML = '<div class="empty-state">No context committed yet.<br>Propose commits as the squad reaches decisions.</div>';
                return;
            }

            el.innerHTML = state.context.entries.map(e => `
                <div class="context-entry">
                    <div class="context-entry-version">v${e.version} Â· ${e.origin === 'orchestrator_detected' ? 'ğŸ” detected' : 'ğŸ“‹ proposed'}</div>
                    <div class="context-entry-content">${esc(e.content)}</div>
                    <div class="context-entry-meta">by ${esc(e.committed_by)} Â· ${new Date(e.committed_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>
                </div>
            `).join('');
        }

        function renderPendingCommits() {
            const el = document.getElementById('pendingCommits');
            if (!state.pendingCommits.length) {
                el.innerHTML = '<div class="empty-state">No pending proposals.</div>';
                return;
            }

            el.innerHTML = state.pendingCommits.map(c => {
                const s = c.vote_summary || {};
                return `<div class="commit-card">
                    <div class="commit-content">${esc(c.content)}</div>
                    <div class="commit-proposer">Proposed by ${esc(c.proposed_by_name)}</div>
                    <div class="commit-votes">
                        <span class="vote-count approve">âœ… ${s.approvals || 0}</span>
                        <span class="vote-count reject">âŒ ${s.rejections || 0}</span>
                        <span class="vote-count">â­ï¸ ${s.abstentions || 0}</span>
                    </div>
                    ${state.myName ? `
                    <div class="vote-actions">
                        <button class="vote-btn approve" onclick="voteOnCommit('${c.id}', 'approve')">Approve</button>
                        <button class="vote-btn reject" onclick="voteOnCommit('${c.id}', 'reject')">Reject</button>
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s || '';
            return d.innerHTML;
        }

        function formatContent(content) {
            // Basic markdown-lite: bold, code, backtick IDs
            return esc(content)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code style="font-family: JetBrains Mono, monospace; font-size: 12px; background: var(--bg-elevated); padding: 2px 6px; border-radius: 4px;">$1</code>');
        }

        function scrollToBottom() {
            const el = document.getElementById('messagesContainer');
            setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50);
        }

        function updateConnectionStatus(connected) {
            const el = document.getElementById('connStatus');
            const dot = document.getElementById('statusDot');
            if (connected) {
                el.textContent = 'connected';
                el.className = 'connection-status connected';
                dot.style.background = 'var(--accent-green)';
            } else {
                el.textContent = 'reconnecting...';
                el.className = 'connection-status disconnected';
                dot.style.background = 'var(--accent-red)';
            }
        }

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = '44px';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // â”€â”€ Initialize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        connect();
    </script>
</body>
</html>
